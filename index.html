<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tram Ginko - Temps R√©el</title>
    <script src="https://api.ginko.voyage/api.js?apiKey=424d76cbcc3f4f36ef037355db9d3164"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 15px;
            color: white;
        }

        .container { max-width: 800px; margin: 0 auto; }

        h1 { text-align: center; margin-bottom: 20px; font-size: 1.8em; }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .line-btn {
            padding: 12px 35px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            background: rgba(255,255,255,0.1);
            color: white;
            transition: all 0.3s;
        }

        .line-btn:hover { background: rgba(255,255,255,0.2); }
        .line-btn.active { background: #4ade80; color: #1a1a2e; }

        .line-display {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
        }

        .header-row {
            display: grid;
            grid-template-columns: 40px minmax(60px, 80px) 1fr minmax(60px, 80px) 40px;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .header-dir {
            font-weight: bold;
            font-size: 0.85em;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
        }

        .header-dir.left { 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            color: #1a1a2e;
            grid-column: 1 / 3;
        }
        
        .header-dir.right { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white;
            grid-column: 4 / 6;
        }

        .header-center {
            text-align: center;
            font-size: 0.9em;
            color: rgba(255,255,255,0.6);
        }

        .station-row {
            display: grid;
            grid-template-columns: 40px minmax(60px, 80px) 1fr minmax(60px, 80px) 40px;
            gap: 10px;
            align-items: center;
            margin-bottom: 6px;
            padding: 4px 0;
            min-height: 44px;
        }

        /* Ligne gauche avec point */
        .line-left {
            position: relative;
            width: 40px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .line-left::before {
            content: '';
            position: absolute;
            left: 50%;
            top: -10px;
            bottom: -10px;
            width: 4px;
            background: linear-gradient(180deg, #f59e0b, #d97706);
            transform: translateX(-50%);
        }

        .dot-left {
            width: 20px;
            height: 20px;
            background: white;
            border: 4px solid #f59e0b;
            border-radius: 50%;
            z-index: 2;
            position: relative;
        }

        .dot-left.tram-here {
            background: #4ade80;
            border-color: #22c55e;
            width: 26px;
            height: 26px;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.8);
        }

        .tram-icon-left {
            position: absolute;
            left: -25px;
            font-size: 1.3em;
            animation: bounce 1s infinite;
        }

        /* Ligne droite avec point */
        .line-right {
            position: relative;
            width: 40px;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .line-right::before {
            content: '';
            position: absolute;
            left: 50%;
            top: -10px;
            bottom: -10px;
            width: 4px;
            background: linear-gradient(180deg, #3b82f6, #2563eb);
            transform: translateX(-50%);
        }

        .dot-right {
            width: 20px;
            height: 20px;
            background: white;
            border: 4px solid #3b82f6;
            border-radius: 50%;
            z-index: 2;
            position: relative;
        }

        .dot-right.tram-here {
            background: #4ade80;
            border-color: #22c55e;
            width: 26px;
            height: 26px;
            box-shadow: 0 0 15px rgba(74, 222, 128, 0.8);
        }

        .tram-icon-right {
            position: absolute;
            right: -25px;
            font-size: 1.3em;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Temps d'attente */
        .time-left, .time-right {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .time-left { justify-content: flex-end; }
        .time-right { justify-content: flex-start; }

        .time-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.8em;
            text-align: center;
            white-space: nowrap;
        }

        .time-badge.imminent {
            background: #22c55e;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .time-badge.soon {
            background: #f59e0b;
            color: #1a1a2e;
        }

        .time-badge.normal {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        .no-tram {
            color: rgba(255,255,255,0.3);
            font-size: 0.75em;
        }

        /* Nom station au centre */
        .station-name {
            text-align: center;
            font-size: 0.85em;
            font-weight: 600;
            padding: 8px;
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .station-name.has-tram {
            background: rgba(74, 222, 128, 0.2);
        }

        /* L√©gende */
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            font-size: 0.8em;
            flex-wrap: wrap;
        }

        .legend-item { display: flex; align-items: center; gap: 6px; }

        .legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .legend-dot.green { background: #4ade80; }
        .legend-dot.orange { background: white; border: 3px solid #f59e0b; }
        .legend-dot.blue { background: white; border: 3px solid #3b82f6; }

        .refresh-btn {
            display: block;
            margin: 20px auto 0;
            padding: 12px 30px;
            background: #4ade80;
            color: #1a1a2e;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }

        .refresh-btn:hover { background: #22c55e; }

        .last-update {
            text-align: center;
            margin-top: 15px;
            color: rgba(255,255,255,0.5);
            font-size: 0.8em;
        }

        /* Responsive - maintenir alignement vertical */
        @media (max-width: 500px) {
            .header-row, .station-row {
                grid-template-columns: 36px minmax(50px, 1fr) auto minmax(50px, 1fr) 36px;
                gap: 5px;
            }
            
            .line-left, .line-right {
                width: 36px;
                min-width: 36px;
            }
            
            .station-name {
                font-size: 0.75em;
                padding: 6px 4px;
            }
            
            .time-badge {
                padding: 3px 6px;
                font-size: 0.7em;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: rgba(255,255,255,0.6);
        }

        #stationsContainer { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöä Tram Besan√ßon</h1>

        <div class="controls">
            <button class="line-btn active" onclick="selectLine('T1')">Ligne T1</button>
            <button class="line-btn" onclick="selectLine('T2')">Ligne T2</button>
        </div>

        <div class="line-display">
            <div class="header-row">
                <div class="header-dir left" id="leftHeader">‚Üê Hauts Chazal</div>
                <div class="header-center">Stations</div>
                <div class="header-dir right" id="rightHeader">Chalezeule ‚Üí</div>
            </div>

            <div id="loading" class="loading">Chargement...</div>
            
            <div id="stationsContainer">
                <div id="stations"></div>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-dot green"></div><span>Tram √† quai</span></div>
            <div class="legend-item"><div class="legend-dot orange"></div><span>Vers Hauts Chazal</span></div>
            <div class="legend-item"><div class="legend-dot blue"></div><span>Vers Chalezeule</span></div>
        </div>

        <button class="refresh-btn" onclick="loadAllData()">üîÑ Actualiser</button>
        <div id="lastUpdate" class="last-update"></div>
    </div>

    <script>
        let currentLine = 'T1';

        const lines = {
            T1: {
                leftDir: 'Hauts du Chazal',
                rightDir: 'Chalezeule',
                leftShort: 'Hauts Chazal',
                rightShort: 'Chalezeule',
                stations: [
                    { id: 'HAUTCH', name: 'Hauts du Chazal' },
                    { id: 'EPOISS', name: '√âpoisses' },
                    { id: 'ORCHAM', name: 'Orchamps' },
                    { id: 'TEMIS', name: 'Temis' },
                    { id: 'JHAAG', name: 'Jules Haag' },
                    { id: 'CHATEA', name: 'Ch√¢teaufarine' },
                    { id: 'MICROP', name: 'Micropolis' },
                    { id: '8SEPT', name: '8 Septembre' },
                    { id: 'CANOT', name: 'Canot' },
                    { id: 'MARCHE', name: 'March√© Beaux-Arts' },
                    { id: 'BATTAN', name: 'Battant' },
                    { id: 'MAIRIE', name: 'Mairie' },
                    { id: 'CHAMAR', name: 'Chamars' },
                    { id: 'LACOUR', name: 'Lacour' },
                    { id: 'GRETTE', name: 'Grette' },
                    { id: 'BOUSSI', name: 'Boussingots' },
                    { id: 'PETITC', name: 'Petit-Charmaillot' },
                    { id: 'HERBUE', name: 'Herbue' },
                    { id: 'NAVERE', name: 'Nav√®re' },
                    { id: 'CHALEZ', name: 'Chalezeule' }
                ]
            },
            T2: {
                leftDir: 'Hauts du Chazal',
                rightDir: 'Gare Viotte',
                leftShort: 'Hauts Chazal',
                rightShort: 'Gare Viotte',
                stations: [
                    { id: 'HAUTCH', name: 'Hauts du Chazal' },
                    { id: 'EPOISS', name: '√âpoisses' },
                    { id: 'ORCHAM', name: 'Orchamps' },
                    { id: 'TEMIS', name: 'Temis' },
                    { id: 'JHAAG', name: 'Jules Haag' },
                    { id: 'CHATEA', name: 'Ch√¢teaufarine' },
                    { id: 'MICROP', name: 'Micropolis' },
                    { id: '8SEPT', name: '8 Septembre' },
                    { id: 'CANOT', name: 'Canot' },
                    { id: 'REVOLU', name: 'R√©volution' },
                    { id: 'FLORE', name: 'Flore' },
                    { id: 'VAITES', name: 'Va√Ætes' },
                    { id: 'CHAPRA', name: 'Chaprais' },
                    { id: 'VIOTTE', name: 'Gare Viotte' }
                ]
            }
        };

        function selectLine(line) {
            currentLine = line;
            document.querySelectorAll('.line-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            const info = lines[line];
            document.getElementById('leftHeader').textContent = '‚Üê ' + info.leftShort;
            document.getElementById('rightHeader').textContent = info.rightShort + ' ‚Üí';
            
            buildStations();
            loadAllData();
        }

        function buildStations() {
            const container = document.getElementById('stations');
            container.innerHTML = '';
            
            lines[currentLine].stations.forEach(station => {
                const row = document.createElement('div');
                row.className = 'station-row';
                row.innerHTML = `
                    <div class="line-left" id="lineleft-${station.id}">
                        <div class="dot-left" id="dotleft-${station.id}"></div>
                    </div>
                    <div class="time-left" id="timeleft-${station.id}">
                        <span class="no-tram">--</span>
                    </div>
                    <div class="station-name" id="name-${station.id}">${station.name}</div>
                    <div class="time-right" id="timeright-${station.id}">
                        <span class="no-tram">--</span>
                    </div>
                    <div class="line-right" id="lineright-${station.id}">
                        <div class="dot-right" id="dotright-${station.id}"></div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function loadAllData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('stationsContainer').style.display = 'none';
            
            let loaded = 0;
            const stations = lines[currentLine].stations;

            stations.forEach(station => {
                ginkoAPI('TA/getTempsAttente', { idArret: station.id }, 
                    function(result) {
                        updateStation(station.id, result);
                        loaded++;
                        if (loaded >= stations.length) finishLoading();
                    },
                    function(err) {
                        console.log('Erreur:', station.id);
                        loaded++;
                        if (loaded >= stations.length) finishLoading();
                    }
                );
            });
        }

        function updateStation(stationId, result) {
            const lineInfo = lines[currentLine];
            let leftTimes = [];
            let rightTimes = [];

            if (result && result.listePassages) {
                result.listePassages.forEach(p => {
                    if (p.ligne === currentLine) {
                        const t = parseInt(p.tempsAttente);
                        const dest = p.destination.toLowerCase();
                        const leftKey = lineInfo.leftDir.split(' ')[0].toLowerCase();
                        
                        if (dest.includes(leftKey)) {
                            leftTimes.push(t);
                        } else {
                            rightTimes.push(t);
                        }
                    }
                });
            }

            // Update gauche
            const timeLeftDiv = document.getElementById('timeleft-' + stationId);
            const dotLeftDiv = document.getElementById('dotleft-' + stationId);
            const lineLeftDiv = document.getElementById('lineleft-' + stationId);
            
            // Retirer ancien icon gauche
            const oldIconLeft = lineLeftDiv.querySelector('.tram-icon-left');
            if (oldIconLeft) oldIconLeft.remove();

            if (leftTimes.length > 0) {
                timeLeftDiv.innerHTML = leftTimes.slice(0, 2).map(t => timeBadge(t)).join('');
                if (leftTimes[0] <= 1) {
                    dotLeftDiv.classList.add('tram-here');
                    const icon = document.createElement('div');
                    icon.className = 'tram-icon-left';
                    icon.textContent = 'üöä';
                    lineLeftDiv.appendChild(icon);
                } else {
                    dotLeftDiv.classList.remove('tram-here');
                }
            } else {
                timeLeftDiv.innerHTML = '<span class="no-tram">--</span>';
                dotLeftDiv.classList.remove('tram-here');
            }

            // Update droite
            const timeRightDiv = document.getElementById('timeright-' + stationId);
            const dotRightDiv = document.getElementById('dotright-' + stationId);
            const lineRightDiv = document.getElementById('lineright-' + stationId);
            
            // Retirer ancien icon droite
            const oldIconRight = lineRightDiv.querySelector('.tram-icon-right');
            if (oldIconRight) oldIconRight.remove();

            if (rightTimes.length > 0) {
                timeRightDiv.innerHTML = rightTimes.slice(0, 2).map(t => timeBadge(t)).join('');
                if (rightTimes[0] <= 1) {
                    dotRightDiv.classList.add('tram-here');
                    const icon = document.createElement('div');
                    icon.className = 'tram-icon-right';
                    icon.textContent = 'üöä';
                    lineRightDiv.appendChild(icon);
                } else {
                    dotRightDiv.classList.remove('tram-here');
                }
            } else {
                timeRightDiv.innerHTML = '<span class="no-tram">--</span>';
                dotRightDiv.classList.remove('tram-here');
            }

            // Highlight station si tram proche
            const nameDiv = document.getElementById('name-' + stationId);
            if ((leftTimes.length && leftTimes[0] <= 1) || (rightTimes.length && rightTimes[0] <= 1)) {
                nameDiv.classList.add('has-tram');
            } else {
                nameDiv.classList.remove('has-tram');
            }
        }

        function timeBadge(t) {
            if (t === 0) return '<div class="time-badge imminent">0</div>';
            if (t <= 2) return '<div class="time-badge imminent">' + t + '</div>';
            if (t <= 5) return '<div class="time-badge soon">' + t + '</div>';
            return '<div class="time-badge normal">' + t + '</div>';
        }

        function finishLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('stationsContainer').style.display = 'block';
            document.getElementById('lastUpdate').textContent = 'Mise √† jour : ' + new Date().toLocaleTimeString('fr-FR');
        }

        window.onload = function() {
            buildStations();
            loadAllData();
            setInterval(loadAllData, 30000);
        };
    </script>
</body>
</html>
